# Automating report generation with Papermill and Rclone


Table of contents: 
- The goal of the post
    - Not everyone knows python
    - Install python in other computers? 
    - Deploy a completely new solution? 
    - Use the tools we have
- Creating a jupyter notebook report from an excel file 
    - Simple excel file
    - Notebook example
- Converting the notebook to an html file
    - Nbconvert to html
- Using papermill to run the report for different excel files
    - Example with another excel file 
- Using rclone to sync directories 
    - rclone 
- Bringing it all together
    - Script walkthrough
    - Etc next steps. 


## Automating report generation with Python

Not everyone can code. This might seem like an obvious statement, but once you start using python to automate or analyze things around you, you start to encounter a big problem: reproducability. By this I mean the fact that not everyone can/ knows how to run your scripts, use your tools, etc. 

Let us say you built a killer script. How exactly do you make someone who has never heard the word "python" use it? You could teach them python, but that would take a long time.

In this post, we will cover how you can automatically generate shareable html reports from any excel file using a combination of tools, centered around python.  

So sit tight, and let's get started. 

## Creating a jupyter notebook report from an excel file

Let us say you have an excel file (`sales_january.xlsx`) with a list of the sales generated by a group of employees. Just like this:

<br/>
<center>
<img src="/images/january_sales_excel.png" alt="excel" style="width:50%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
</center>
<br/>

Let's start by using a jupyter notebook `sales_january.ipynb` to create a very simple analysis of that sales data. 

We start by importing the [pandas](https://pandas.pydata.org/) library. After that we define the name of our file using the `filename` variable. Finally, we use the `read_excel` function to read our data into a pandas dataframe. 

```python
import pandas as pd
import matplotlib.pyplot as plt
%matplotlib inline

filename = "sales_january.xlsx"
```
When printing the `data` dataframe, we get the following:

<br/>
<center>
<img src="/images/january_sales_table.png" alt="excel" style="width:40%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
</center>
<br/>

After that, we simply plot the data using: 

```python
data.plot(kind="bar", title=f"Sales report from {filename}")
```

And get the following:

<br/>
<center>
<img src="/images/january_sales_plot.png" alt="excel" style="width:60%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
</center>
<br/>

And that's it! We got ourselves a jupyter notebook that analyzes (a very simple example here) a sales report in excel. Now let's say we want to share that report with other people in the organization, what do we do? 

notebook link!
[Browse the notebook here!]()


## Generating html reports from Jupyter Notebooks to share with colleagues

In my experience, the easiest way to share a report with colleagues is to use a little tool called [nbconvert](https://nbconvert.readthedocs.io/en/latest/). Nbconvert allows you to generate an html version of your notebook. To do this, start by navigating to the same directory where your notebook is and run the following from your terminal: 

```bash
$ jupyter nbconvert sales_january.ipynb
```
You will see a new file named `sales_january.html` was created. HTML files are better than `ipynb` in the measure that they are easily shareable via email, message, or any other way. 

But lets us say that this sales report comes in every month, how can we automatically run this notebook with any excel file in the same format? 

## Automating report generation using papermill

[Papermill](https://papermill.readthedocs.io/en/latest/) is a handy tool that allows us to "parameterize and execute" Jupyter Notebooks. This means that papermill allows you execute the same jupyter notebook, with different variables defined outside its context. 

To install it, run `pip install papermill`, or follow the more extensive [installation instructions](https://papermill.readthedocs.io/en/latest/installation.html).

Let us say we want to generate the same report as above, but with another excel file: `sales_february.xlsx`. You should have in your directory, the following:

```bash
├── sales_february.xlsx
├── sales_january.html
├── sales_january.ipynb
└── sales_january.xlsx
```

The first step is to parameterize our notebook, to do this, let us create a `template.ipynb` file. This notebook is very similar to `sales_january.ipynb` but with a small difference: a new cell with a tag `parameters`. Just like this:

<br/>
<center>
<img src="/images/template_notebook_screenshot.png" alt="excel" style="width:100%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
</center>
<br/>

(If you have trouble adding a tag to your notebook, visit [this link](https://papermill.readthedocs.io/en/latest/usage-parameterize.html#notebook))


The cell with the `parameters` tag, will basically allow you to run this notebook from another python script, while feeding the `filename` variable, any value you would like. 

Now that we have everything in place, let's generate a report for a new `february_sales.xlsx` excel file.

Your directory should look like this: 

```bash
├── sales_february.xlsx
├── sales_january.html
├── sales_january.ipynb
├── sales_january.xlsx
└── template.ipynb
```

To do this, in a new python file, or in your terminal, run the following:

```python
import papermill as pm

pm.execute_notebook(
   'template.ipynb',
   'sales_february.ipynb',
   parameters=dict(filename="sales_february.xlsx")
)
```

Let's brake this down: the `execute_notebook` takes 3 arguments. The first, `template.ipynb` is the name of the file what we will use as a base to run our notebook, the one with the `parameters` tag. The second argument, is the name of the new notebook that we will generate with the new arguments. Finally, `parameters` is a dictionnary of the variables that we want to impose to our template, in this case, the `filename` variable, will now point to our february sales report. 

When running the above code, you will notice a new file in your directory: 


```bash
├── sales_february.ipynb <- This one!
├── sales_february.xlsx
├── sales_january.html
├── sales_january.ipynb
├── sales_january.xlsx
└── template.ipynb
```

Which means, that Papermill has generated a new notebook for us, based on the `sales_february.xlsx`. When openning this notebook, we see a new graph with the new february numbers: 

<br/>
<center>
<img src="/images/february_sales_plot.png" alt="excel" style="width:60%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
</center>
<br/>

This is pretty handy! We could have a continuous script that always runs this notebook with different sales reports from different months. But how can we automate the process even more? 

## A workflow to automatically generate reports in a shared cloud folder

Let's imagine you want to generate automatic reports for every similar excel file. Furthemore, you want to share them with your colleagues. Your colleagues are interested in the reports, but not learning to program python, how would you proceed? 

There are a lot of options, and hardly any incorrect ones, but one I found particularly interesting was using what we already had in a company: a cloud folder (Google Drive, OneDrive, Dropbox). 

Cloud folders are very popular in companies, particularly shared ones. So a good idea would be to create a shared folder where everyone can upload sales excel reports, and automatically generate `html` reports from them, so everyone can read!

Here is the basic architecture of the solution: 

<br/>
<center>
<img src="/images/architecture.png" alt="excel" style="width:60%; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
</center>
<br/>

Let's describe each one of the steps: 
- A user uploads a new excel sales report to a shared cloud folder.
- We sync the cloud folder with a local folder and detect that new excel sales report.
- We use papermill to generate a new notebook file from that new excel sales report. 
- We use nbconvert to generate an html file from that new notebook file. 
- We upload the html file to the cloud folder, so the user can read it.  

Let's start building this step by step: 

#### 1.Sync a cloud folder with a local folder and detect new files 
To sync cloud directories with local directories, we will a tool called [Rclone](https://rclone.org/). Of course we will integrate it with python.

Start by installing rclone in the same machine as your local folder (your personal computer or a virtual private server for example). On a Mac or linux: 

```bash
$ curl https://rclone.org/install.sh | sudo bash
```
On windows, download the executable in the [Rclone downloads page](https://rclone.org/downloads/). 

Once rclone is installed, we must configure it: 

